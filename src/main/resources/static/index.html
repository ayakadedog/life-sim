<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äººç”Ÿé‡å¼€æ¨¡æ‹Ÿå™¨ï¼šç°å®ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #f8f5f2; 
            font-family: 'Noto Serif SC', serif; 
            color: #2c3e50;
        }
        .typewriter p {
            overflow: hidden;
            white-space: pre-wrap;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-choice {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-choice:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div id="app" class="max-w-3xl mx-auto p-6 min-h-screen">
    
    <!-- Loading -->
    <div v-if="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p class="text-gray-600 text-lg animate-pulse">{{ loadingText }}</p>
    </div>

    <!-- Header -->
    <header class="mb-6 text-center pt-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2 tracking-wide">äººç”Ÿæ¨¡æ‹Ÿå™¨</h1>
        <p class="text-gray-500 italic">æ€§æ ¼å†³å®šå‘½è¿ Â· ç°å®é‡æ„äººç”Ÿ</p>
    </header>

    <!-- Login Step -->
    <div v-if="step === 0" class="max-w-md mx-auto bg-white p-10 rounded-xl shadow-lg border border-gray-100 mt-20">
        <h2 class="text-2xl font-bold mb-6 text-center">ç™»å½• / æ³¨å†Œ</h2>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">æ‰‹æœºå·</label>
                <input v-model="loginPhone" type="tel" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 focus:ring-2 focus:ring-black focus:outline-none transition" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>
            <button @click="login" class="w-full bg-black text-white py-3 rounded-lg hover:bg-gray-800 transition font-bold shadow-lg">
                å¼€å§‹ä½“éªŒ
            </button>
        </div>
    </div>

    <!-- Main App (Tabs) -->
    <div v-if="step > 0 && user">
        <!-- Tab Navigation -->
        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-lg z-40 flex justify-around py-3">
            <button @click="switchTab('start')" class="flex flex-col items-center" :class="currentTab === 'start' ? 'text-black' : 'text-gray-400'">
                <span class="text-xl">ğŸš€</span>
                <span class="text-xs font-bold mt-1">å¼€å§‹</span>
            </button>
            <button @click="switchTab('history')" class="flex flex-col items-center" :class="currentTab === 'history' ? 'text-black' : 'text-gray-400'">
                <span class="text-xl">ğŸ“œ</span>
                <span class="text-xs font-bold mt-1">å†å²</span>
            </button>
            <button @click="switchTab('mine')" class="flex flex-col items-center" :class="currentTab === 'mine' ? 'text-black' : 'text-gray-400'">
                <span class="text-xl">ğŸ‘¤</span>
                <span class="text-xs font-bold mt-1">æˆ‘çš„</span>
            </button>
        </div>

        <!-- Tab Content: Start -->
        <div v-if="currentTab === 'start'" class="pb-20">
            <!-- Game Flow (Step 1, 2, 3) -->
            
            <!-- Step 1: Detailed Profile -->
            <div v-if="step === 1" class="bg-white p-10 rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-bold mb-8 border-l-4 border-black pl-4">ç¬¬ä¸€ç« ï¼šåˆå§‹è®¾å®š</h2>
        
        <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">å§“å</label>
                        <input v-model="profile.basicInfo.name" type="text" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 focus:ring-2 focus:ring-black focus:outline-none transition">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">æ¸¸æˆæ¨¡å¼</label>
                        <select class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 font-bold" v-model="profile.difficulty" :class="{
                            'text-green-600': profile.difficulty === 'Easy',
                            'text-blue-600': profile.difficulty === 'Normal',
                            'text-orange-600': profile.difficulty === 'Hard',
                            'text-red-600': profile.difficulty === 'Hell'
                        }">
                            <option value="Easy">çˆ½æ–‡æ¨¡å¼ (ä¸€è·¯å¼€æŒ‚)</option>
                            <option value="Normal">å¸¸è§„æ¨¡å¼ (çœŸå®äººç”Ÿ)</option>
                            <option value="Hard">å›°éš¾æ¨¡å¼ (æ­¥æ­¥æƒŠå¿ƒ)</option>
                            <option value="Hell">åœ°ç‹±æ¨¡å¼ (ç»æœ›æ±‚ç”Ÿ)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">åˆå§‹å¹´é¾„</label>
                        <input v-model.number="profile.basicInfo.startAge" type="number" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 focus:ring-2 focus:ring-black focus:outline-none transition">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">å­¦å†</label>
                        <select class="w-full rounded-lg border-gray-300 bg-gray-50 p-3" v-model="profile.basicInfo.educationLevel">
                            <option value="High School">é«˜ä¸­</option>
                            <option value="Junior College">å¤§ä¸“</option>
                            <option value="Bachelor">æœ¬ç§‘</option>
                            <option value="Master">ç¡•å£«</option>
                            <option value="PhD">åšå£«</option>
                            <option value="Overseas Student">ç•™å­¦ç”Ÿ</option>
                            <option value="Self-Taught">è‡ªå­¦æˆæ‰</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">èŒä¸š</label>
                        <input type="text" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3" v-model="profile.basicInfo.profession" placeholder="ä¾‹å¦‚ï¼šç¨‹åºå‘˜ã€è‡ªç”±èŒä¸šè€…">
                    </div>
                </div>

                <!-- Family Background Expansion -->
                <div class="pt-6 border-t border-gray-100">
                     <h3 class="text-sm font-bold text-gray-800 mb-4">å®¶åº­èƒŒæ™¯</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">å®¶åº­èµ„äº§ä¼°å€¼</label>
                            <input type="text" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3" v-model="profile.familyBackground.familyAssets" placeholder="ä¾‹å¦‚ï¼š500ä¸‡ã€ä¸‰å¥—æˆ¿">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">çˆ¶æ¯çŠ¶å†µ</label>
                            <select class="w-full rounded-lg border-gray-300 bg-gray-50 p-3" v-model="profile.familyBackground.parentsStatus">
                                <option value="Parents Alive">çˆ¶æ¯å¥åœ¨</option>
                                <option value="Single Parent">å•äº²å®¶åº­</option>
                                <option value="Orphan">å­¤å„¿</option>
                                <option value="Estranged">å…³ç³»ç–ç¦»</option>
                            </select>
                        </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">çˆ¶äº²èŒä¸š</label>
                            <input type="text" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3" v-model="profile.familyBackground.fatherProfession" placeholder="ä¾‹å¦‚ï¼šå…¬åŠ¡å‘˜">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">æ¯äº²èŒä¸š</label>
                            <input type="text" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3" v-model="profile.familyBackground.motherProfession" placeholder="ä¾‹å¦‚ï¼šæ•™å¸ˆ">
                        </div>
                     </div>
                </div>
                
                <!-- Personal History (Free Text) -->
                <div class="pt-6 border-t border-gray-100">
                     <h3 class="text-sm font-bold text-gray-800 mb-4">äººç”Ÿç»å† (é€‰å¡«)</h3>
                     <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">ä½ çš„æ•…äº‹</label>
                        <textarea class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 h-24" 
                            v-model="profile.basicInfo.lifeExperiences" 
                            placeholder="åœ¨è¿™é‡Œè¾“å…¥ä½ è¿‡å»çš„ç»å†ã€é—æ†¾æˆ–é«˜å…‰æ—¶åˆ»ã€‚è¿™äº›å°†æˆä¸ºä½ å¹³è¡Œäººç”Ÿçš„ä¼ç¬”..."></textarea>
                     </div>
                </div>

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">å‡ºç”Ÿåœ°/å±…ä½åœ°</label>
                    <select v-model="profile.basicInfo.location" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3">
                        <option>ä¸€çº¿åŸå¸‚ (åŒ—ä¸Šå¹¿æ·±)</option>
                        <option>æ–°ä¸€çº¿åŸå¸‚ (æ­æˆæ­¦ç­‰)</option>
                        <option>æ™®é€šåœ°çº§å¸‚</option>
                        <option>åå…«çº¿å°å¿åŸ</option>
                        <option>åè¿œå†œæ‘</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">å®¶åº­èƒŒæ™¯</label>
                    <select v-model="profile.familyBackground.parentsStatus" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3">
                        <option>çˆ¶æ¯å¥åœ¨ï¼Œå®¶åº­å’Œç¦</option>
                        <option>å•äº²å®¶åº­</option>
                        <option>çˆ¶æ¯ç¦»å¼‚ï¼Œå…³ç³»ç´§å¼ </option>
                        <option>å­¤å„¿</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">åˆå§‹å­˜æ¬¾ (è´Ÿæ•°ä»£è¡¨è´Ÿå€º)</label>
                    <input v-model.number="profile.economicStatus.savings" type="number" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">å¥åº·çŠ¶å†µ (ç²¾åŠ›å€¼)</label>
                    <input v-model.number="profile.healthStatus.energyLevel" type="range" min="50" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-4">
                    <div class="text-right text-sm text-gray-500">{{ profile.healthStatus.energyLevel }}</div>
                </div>
            </div>
        </div>

        <button @click="initProbes" class="mt-8 w-full bg-black text-white py-4 rounded-lg hover:bg-gray-800 transition font-bold text-lg shadow-lg">
            ä¸‹ä¸€æ­¥ï¼šæ·±åº¦å‰–æ
        </button>
    </div>

    <!-- Step 2: Psychological Probes -->
    <div v-if="step === 2" class="bg-white p-10 rounded-xl shadow-lg border border-gray-100">
        <h2 class="text-2xl font-bold mb-8 border-l-4 border-black pl-4">ç¬¬äºŒç« ï¼šæ·±åº¦å‰–æ</h2>
        <p class="text-gray-500 mb-6">ä¸ºäº†ç”Ÿæˆæ›´çœŸå®çš„å¹³è¡Œå®‡å®™ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä½ çš„å†…å¿ƒä¸–ç•Œ...</p>
        
        <div class="space-y-8">
            <div v-for="(probe, index) in probes" :key="index" class="space-y-2">
                <label class="block text-lg font-bold text-gray-800">{{ index + 1 }}. {{ probe }}</label>
                <textarea v-model="probeAnswers[probe]" rows="3" class="w-full rounded-lg border-gray-300 bg-gray-50 p-3 focus:ring-2 focus:ring-black focus:outline-none transition" placeholder="è¯·çœŸè¯šä½œç­”..."></textarea>
            </div>
        </div>

        <button @click="startSimulation" class="mt-8 w-full bg-black text-white py-4 rounded-lg hover:bg-gray-800 transition font-bold text-lg shadow-lg">
            å¼€å§‹æ¨¡æ‹Ÿäººç”Ÿ
        </button>
    </div>

    <!-- Step 3: Game Loop -->
    <div v-if="step === 3 && currentProfile" class="space-y-6">
        <!-- Status Bar -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-wrap justify-between items-center text-sm sticky top-0 z-30">
            <div class="flex items-center space-x-4">
                <div class="font-bold text-xl">{{ currentProfile.currentAge }}å²</div>
                <div class="text-gray-500">{{ currentProfile.basicInfo.profession }}</div>
                <div class="text-gray-500">{{ currentProfile.basicInfo.location }}</div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="flex items-center">
                    <span class="mr-2">â¤ï¸</span>
                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full bg-red-500" :style="{ width: currentProfile.healthStatus.energyLevel + '%' }"></div>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="mr-2">ğŸ’°</span>
                    <span class="font-bold">Â¥{{ currentProfile.economicStatus.savings.toLocaleString() }}</span>
                </div>
            </div>
        </div>

        <!-- Main Event Display -->
        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100 min-h-[300px] flex flex-col justify-center typewriter">
            <p class="text-lg leading-loose text-gray-800">{{ displayedEvent }}</p>
        </div>

        <!-- Interaction Area -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Custom Action -->
            <div class="bg-white p-6 rounded-xl shadow border border-gray-100 md:col-span-2">
                <h3 class="font-bold text-gray-700 mb-4">ä½ çš„æŠ‰æ‹©</h3>
                <div class="flex space-x-2">
                    <input type="text" v-model="customAction" class="flex-1 rounded-lg border-gray-300 bg-gray-50 p-3 focus:ring-2 focus:ring-black focus:outline-none transition" placeholder="æˆ‘æƒ³..." @keyup.enter="submitCustomAction">
                    <button @click="submitCustomAction" class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-800 transition">
                        æ‰§è¡Œ
                    </button>
                </div>
                
                <!-- Suggested Choices (if any) -->
                <div v-if="currentProfile.availableChoices && currentProfile.availableChoices.length > 0" class="mt-4 flex flex-wrap gap-2">
                    <button v-for="choice in currentProfile.availableChoices" :key="choice" @click="nextYear(choice)" class="btn-choice bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-full text-sm font-medium transition">
                        {{ choice }}
                    </button>
                </div>
            </div>

            <!-- System Actions -->
            <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4">æ—¶å…‰é£é€</h3>
                <div class="flex items-center space-x-2">
                    <input type="number" v-model.number="skipValue" class="w-20 rounded-lg border-gray-300 bg-gray-50 p-2 text-center" min="1" max="10">
                    <button @click="skipYears" class="flex-1 bg-gray-100 text-gray-800 py-2 rounded-lg font-bold hover:bg-gray-200 transition">
                        è·³è¿‡ {{ skipValue }} å¹´
                    </button>
                </div>
            </div>

            <!-- Legacy System -->
            <div class="bg-white p-6 rounded-xl shadow border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4">å®¶æ—ä¼ æ‰¿</h3>
                <button @click="createLegacy" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold hover:bg-black transition">
                    å¼€å¯ä¸‹ä¸€ä»£
                </button>
            </div>
        </div>
    </div>

    <!-- Tab Content: History -->
    <div v-if="currentTab === 'history'" class="pb-20 space-y-4">
        <h2 class="text-2xl font-bold mb-6">äººç”Ÿå±¥å†</h2>
        <div v-for="instance in historyList" :key="instance.id" class="bg-white p-6 rounded-lg shadow border border-gray-100">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h3 class="font-bold text-lg">{{ instance.userProfile?.basicInfo?.name || 'æœªçŸ¥è§’è‰²' }}</h3>
                    <p class="text-sm text-gray-500">{{ instance.userProfile?.basicInfo?.profession || 'æ— ä¸šæ¸¸æ°‘' }} Â· {{ instance.userProfile?.currentAge || 0 }}å²</p>
                </div>
                <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800" v-if="instance.status === 'ACTIVE'">è¿›è¡Œä¸­</span>
                <span class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-800" v-else>å·²å®Œç»“</span>
            </div>
            <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                {{ instance.userProfile ? getScenarioEvent(instance.userProfile.currentScenario) : 'æš‚æ— è®°å½•' }}
            </p>
            <div class="flex justify-end space-x-2">
                <button @click="continueGame(instance)" class="text-sm bg-black text-white px-4 py-2 rounded hover:bg-gray-800 transition">
                    ç»§ç»­æ—…ç¨‹
                </button>
            </div>
        </div>
        <div v-if="historyList.length === 0" class="text-center text-gray-400 py-10">
            æš‚æ— å†å²è®°å½•ï¼Œå¿«å»å¼€å¯ä¸€æ®µæ–°äººç”Ÿå§ï¼
        </div>
    </div>

    <!-- Tab Content: Mine -->
    <div v-if="currentTab === 'mine'" class="pb-20 space-y-4">
        <h2 class="text-2xl font-bold mb-6">æˆ‘çš„è§’è‰²å¡</h2>
        <div v-for="template in templates" :key="template.id" class="bg-white p-6 rounded-lg shadow border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-yellow-400 text-xs font-bold px-2 py-1 rounded-bl">TEMPLATE</div>
            <h3 class="font-bold text-lg mb-2">{{ template.name }}</h3>
            <div class="text-sm text-gray-600 space-y-1">
                <p>èŒä¸š: {{ safeParse(template.basicInfo).profession || 'æœªçŸ¥' }}</p>
                <p>åˆå§‹èµ„äº§: Â¥{{ safeParse(template.initialAttributes).savings || 0 }}</p>
            </div>
            <button @click="useTemplate(template)" class="mt-4 w-full border border-black text-black py-2 rounded hover:bg-gray-50 transition text-sm font-bold">
                ä½¿ç”¨æ­¤æ¨¡æ¿é‡ç”Ÿ
            </button>
        </div>
        <div v-if="templates.length === 0" class="text-center text-gray-400 py-10">
            æš‚æ— æ”¶è—çš„è§’è‰²æ¨¡æ¿
        </div>
        
        <div class="mt-8 pt-8 border-t border-gray-200">
             <div class="bg-gray-50 p-4 rounded-lg">
                <p class="text-xs text-gray-500 mb-1">å½“å‰ç™»å½•ç”¨æˆ·</p>
                <p class="font-bold text-lg">{{ user.phone }}</p>
             </div>
        </div>
    </div>

</div>
</div>

<script src="/js/app.js?v=2"></script>
</body>
</html>
